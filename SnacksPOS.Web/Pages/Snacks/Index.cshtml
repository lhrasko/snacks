@page
@model SnacksModel
@{
    ViewData["Title"] = "Snacks - Delicious Treats Await";
}

<div class="container mx-auto px-4 py-8">
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
            üçø Delicious Snacks
        </h1>
        <p class="text-lg opacity-80 max-w-2xl mx-auto">
            Discover our amazing selection of fresh snacks and treats. 
            Each item is carefully crafted to satisfy your cravings!
        </p>
    </div>

    @if (Model.Products.Any())
    {
        <div class="product-grid">
            @foreach (var product in Model.Products)
            {
                <div class="product-card" 
                     data-product-id="@product.Id" 
                     data-product-name="@product.Name" 
                     data-product-price="@product.Price">
                    <div class="product-image">
                        @{
                            var name = product.Name?.ToLower() ?? "";
                            if (name.Contains("trail")) {
                                <span>ü•ú</span>;
                            } else if (name.Contains("protein")) {
                                <span>üí™</span>;
                            } else if (name.Contains("chips")) {
                                <span>üçü</span>;
                            } else if (name.Contains("cookie")) {
                                <span>üç™</span>;
                            } else if (name.Contains("drink")) {
                                <span>ü•§</span>;
                            } else {
                                <span>üçé</span>;
                            }
                        }
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">@product.Name</h3>
                        <p class="product-description">@product.Description</p>
                        <div class="product-footer">
                            <span class="product-price">$@product.Price.ToString("0.00")</span>
                            <button class="quick-add-btn" 
                                    data-product-id="@product.Id"
                                    onclick="toggleCartItem(this)">
                                <span class="add-text">
                                    <span>‚ö°</span>
                                    <span>Add</span>
                                </span>
                                <span class="remove-text" style="display: none;">
                                    <span>‚ùå</span>
                                    <span>Remove</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-16">
            <div class="text-6xl mb-4">üò¥</div>
            <h2 class="text-2xl font-bold mb-4">No Snacks Available</h2>
            <p class="text-lg opacity-75">
                Looks like we're out of snacks right now. Check back soon!
            </p>
        </div>
    }
</div>

@section Scripts{
<script>
let cartCount = 0;

function triggerBounce(el) {
    el.classList.remove('dramatic-bounce');
    void el.offsetWidth;
    el.classList.add('dramatic-bounce');
}

function toggleCartItem(button) {
    const productId = parseInt(button.getAttribute('data-product-id'));
    const card = button.closest('.product-card');
    const name = card.getAttribute('data-product-name');
    const price = parseFloat(card.getAttribute('data-product-price'));

    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const existingItem = cart.find(item => item.productId == productId);

    if (existingItem) {
        // Remove item from cart
        const index = cart.findIndex(item => item.productId == productId);
        cart.splice(index, 1);
        console.log('Removed item from cart');
    } else {
        // Add item to cart
        cart.push({
            productId: productId,
            quantity: 1,
            snapshotPrice: price
        });
        console.log('Added new item to cart');
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    console.log('Cart saved to localStorage:', cart);

    // Animation: bounce the product card
    triggerBounce(card);

    // Update all button states and cart display
    updateAllButtonStates();
    updateCartDisplay();
}

function addToCartFromData(element) {
    const id = parseInt(element.getAttribute('data-product-id'));
    const name = element.getAttribute('data-product-name');
    const price = parseFloat(element.getAttribute('data-product-price'));
    
    addToCart(id, name, price);
}

function addToCart(id, name, price) {
    console.log('Adding to cart:', id, name, price);
    
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const existingItem = cart.find(item => item.productId == id);
    
    if (existingItem) {
        existingItem.quantity++;
        console.log('Updated existing item quantity:', existingItem.quantity);
    } else {
        cart.push({
            productId: id,
            quantity: 1,
            snapshotPrice: price
        });
        console.log('Added new item to cart');
    }
    
    localStorage.setItem('cart', JSON.stringify(cart));
    console.log('Cart saved to localStorage:', cart);
    
    // Update cart count and show checkout button
    updateAllButtonStates();
    updateCartDisplay();
}

function updateAllButtonStates() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const buttons = document.querySelectorAll('.quick-add-btn');
    
    buttons.forEach(button => {
        const productId = parseInt(button.getAttribute('data-product-id'));
        const isInCart = cart.some(item => item.productId === productId);
        
        const addText = button.querySelector('.add-text');
        const removeText = button.querySelector('.remove-text');
        
        if (isInCart) {
            addText.style.display = 'none';
            removeText.style.display = 'flex';
            button.classList.add('in-cart');
        } else {
            addText.style.display = 'flex';
            removeText.style.display = 'none';
            button.classList.remove('in-cart');
        }
    });
}

function updateCartDisplay() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    cartCount = cart.reduce((total, item) => total + item.quantity, 0);
    
    const checkoutFab = document.getElementById('checkoutFab');
    
    console.log('Cart count:', cartCount);
    console.log('Checkout button element:', checkoutFab);
    
    if (checkoutFab) {
        if (cartCount > 0) {
            checkoutFab.style.display = 'flex';
            
            // Update the button text with the new format
            checkoutFab.innerHTML = `View Cart ‚Ä¢ ${cartCount} item${cartCount !== 1 ? 's' : ''}`;
            
            // Add bounce animation
            checkoutFab.classList.add('dramatic-cart-bounce');
            setTimeout(() => {
                checkoutFab.classList.remove('dramatic-cart-bounce');
            }, 1000);
        } else {
            checkoutFab.style.display = 'none';
        }
    }
}

// Update cart count and button states on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    const checkoutFab = document.getElementById('checkoutFab');
    console.log('Checkout button element found:', checkoutFab);
    
    updateAllButtonStates();
    updateCartDisplay();
});

// Update cart display when storage changes (useful for multiple tabs)
window.addEventListener('storage', function(e) {
    if (e.key === 'cart') {
        updateCartDisplay();
    }
});
</script>
}
